name: Build EFC Master (PDF + HTML)

on:
  push:
    paths:
      - "theory/master/**"
      - ".github/workflows/build_efc_master_dual.yml"
  workflow_dispatch:

jobs:
  build-master:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # Checkout repo
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------------
      # Install LaTeX + Pandoc
      # -------------------------------
      - name: Install LaTeX + Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-latex-base \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-science \
            latexmk

      # -------------------------------
      # Clean old HTML so no fallback occurs
      # -------------------------------
      - name: Remove old generated HTML
        run: |
          rm -f theory/master/efc_master.html
          rm -f docs/efc_master.html

      # -------------------------------
      # Build PDF
      # -------------------------------
      - name: Build EFC Master PDF
        working-directory: theory/master
        run: |
          latexmk -pdf -interaction=nonstopmode efc_master.tex

      # -------------------------------
      # Create HTML Template (perfect clean version)
      # -------------------------------
      - name: Create HTML Template
        working-directory: theory/master
        run: |
          cat > efc_html_template.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>EFC Master Document</title>

<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
  :root {
    --max-width: 38rem;
    --font-body: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    --font-size: 17px;
  }

  html[data-theme="light"] { background:#fbfbfb; color:#111; }
  html[data-theme="dark"]  { background:#111; color:#ddd; }

  body {
    margin: 0 auto;
    max-width: var(--max-width);
    padding: 3rem 1.8rem;
    font-family: var(--font-body);
    font-size: var(--font-size);
    line-height: 1.6;
  }

  h1, h2, h3 {
    font-weight: 600;
    margin-top: 2.2rem;
  }

  img {
    max-width: 100%;
    height: auto;
  }

  pre, code {
    background: #f0f0f0;
    padding: 0.5rem;
    border-radius: 4px;
  }

  #TOC {
    margin-bottom: 2.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #ccc;
  }

  #TOC ul { list-style: none; padding-left: 0; }
  #TOC li { margin: 0.35rem 0; }

  .theme-toggle {
    position: fixed;
    top: 12px;
    right: 12px;
    padding: 0.3rem 0.7rem;
    background: #444;
    color: #fff;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    opacity: 0.85;
  }
</style>

<script>
  function toggleTheme() {
    let h = document.documentElement;
    h.dataset.theme = (h.dataset.theme === "dark") ? "light" : "dark";
  }
  document.documentElement.dataset.theme = "light";
</script>

</head>
<body>
<button class="theme-toggle" onclick="toggleTheme()">Theme</button>

$body$

</body>
</html>
EOF

      # -------------------------------
      # Build HTML via Pandoc Template
      # -------------------------------
      - name: Build HTML via Pandoc Template
        working-directory: theory/master
        run: |
          pandoc efc_master.tex \
            --from=latex \
            --to=html5 \
            --mathjax \
            --standalone \
            --template=efc_html_template.html \
            --metadata title="EFC Master Document" \
            --output=efc_master.html

      # -------------------------------
      # Sanity check: ensure template was actually used
      # -------------------------------
      - name: Verify template usage
        working-directory: theory/master
        run: |
          if ! grep -q "theme-toggle" efc_master.html; then
            echo "TEMPLATE NOT APPLIED â€” FAILING BUILD"
            exit 1
          fi

      # -------------------------------
      # Copy to docs + force commit
      # -------------------------------
      - name: Deploy HTML + figure to docs
        run: |
          mkdir -p docs
          cp theory/master/efc_master.html docs/efc_master.html
          cp output/EFC_vs_LCDM_plot.png docs/EFC_vs_LCDM_plot.png

          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add -A docs/
          git commit -m "Update EFC Master HTML (auto-deploy)" || true
          git push

      # -------------------------------
      # Upload artifacts
      # -------------------------------
      - name: Upload PDF Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EFC_Master_PDF
          path: theory/master/efc_master.pdf

      - name: Upload HTML Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EFC_Master_HTML
          path: docs/efc_master.html
