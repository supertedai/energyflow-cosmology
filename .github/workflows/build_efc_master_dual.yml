name: Build EFC Master (PDF + HTML)

on:
  push:
    paths:
      - "theory/master/**"
      - ".github/workflows/build_efc_master_dual.yml"
  workflow_dispatch:

jobs:
  build-master:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LaTeX + Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-latex-base \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-science \
            latexmk

      # -------------------------------
      # Build PDF
      # -------------------------------
      - name: Build EFC Master PDF
        working-directory: theory/master
        run: |
          latexmk -pdf -interaction=nonstopmode efc_master.tex

      # -------------------------------
      # Create HTML Template (D1 style)
      # -------------------------------
      - name: Create HTML Template
        working-directory: theory/master
        run: |
          cat << 'EOF' > efc_html_template.html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EFC Master Document</title>

  <!-- MathJax -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <!-- Minimal journal-style + dark/light toggle -->
  <style>
    html[data-theme="dark"] {
      background: #111;
      color: #ddd;
    }
    html[data-theme="light"] {
      background: #fdfdfd;
      color: #1a1a1a;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding: 50px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      text-rendering: optimizeLegibility;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 { font-size: 1.8em; }
    }
    img { max-width: 100%; height: auto; }
    pre, code { background: #f2f2f2; padding: 0.5rem; }
    .theme-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 0.4rem 0.7rem;
      cursor: pointer;
      background: #444;
      color: #fff;
      border-radius: 5px;
      font-size: 0.9rem;
    }
  </style>

  <script>
    function toggleTheme() {
      const h = document.documentElement;
      h.dataset.theme = (h.dataset.theme === "dark") ? "light" : "dark";
    }
    document.documentElement.dataset.theme = "light";
  </script>
</head>

<body>
<button class="theme-toggle" onclick="toggleTheme()">Toggle theme</button>

$body$

</body>
</html>
EOF

      # -------------------------------
      # Build Final HTML via template
      # -------------------------------
      - name: Build HTML via Pandoc Template
        working-directory: theory/master
        run: |
          pandoc efc_master.tex \
            --from=latex \
            --to=html5 \
            --mathjax \
            --template=efc_html_template.html \
            --standalone \
            --metadata title="EFC Master Document" \
            --output=efc_master.html

      # -------------------------------
      # Move HTML to docs/
      # -------------------------------
      - name: Move HTML to docs/
        run: |
          mkdir -p docs
          cp theory/master/efc_master.html docs/efc_master.html

      # -------------------------------
      # Upload Artifacts
      # -------------------------------
      - name: Upload PDF
        uses: actions/upload-artifact@v4
        with:
          name: EFC_Master_PDF
          path: theory/master/efc_master.pdf

      - name: Upload HTML
        uses: actions/upload-artifact@v4
        with:
          name: EFC_Master_HTML
          path: docs/efc_master.html
