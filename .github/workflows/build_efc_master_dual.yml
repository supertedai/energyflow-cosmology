name: Build EFC Master (PDF + HTML)

on:
  push:
    paths:
      - "theory/master/**"
      - ".github/workflows/build_efc_master_dual.yml"
  workflow_dispatch:

jobs:
  build-master:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LaTeX + Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-latex-base \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-science \
            latexmk

      # -------------------------------
      # Build PDF
      # -------------------------------
      - name: Build EFC Master PDF
        working-directory: theory/master
        run: |
          latexmk -pdf -interaction=nonstopmode efc_master.tex

      # -------------------------------
      # Build HTML (LaTeX → HTML)
      # -------------------------------
      - name: Convert LaTeX → HTML
        working-directory: theory/master
        run: |
          pandoc efc_master.tex \
            --from=latex \
            --to=html5 \
            --mathjax \
            --standalone \
            --output=efc_master_raw.html

      - name: Inject CSS + Theme Toggle (header/footer)
        working-directory: theory/master
        run: |
          cat << 'EOF' > temp_header.html
<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<title>EFC Master Document</title>

<script src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'></script>

<style>
  body { max-width: 900px; margin: auto; padding: 2rem; font-family: sans-serif; }
  img { max-width: 100%; height: auto; }
  pre, code { background: #f2f2f2; padding: 0.5rem; }

  html[data-theme='dark'] { background: #111; color: #ddd; }
  html[data-theme='light'] { background: #fff; color: #222; }

  .theme-toggle {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 0.4rem 0.7rem;
    cursor: pointer;
    background: #444;
    color: #fff;
    border-radius: 5px;
  }
</style>

<script>
function toggleTheme() {
  let h = document.documentElement;
  h.dataset.theme = (h.dataset.theme === 'dark') ? 'light' : 'dark';
}
</script>

</head>
<body data-theme='light'>
<button class='theme-toggle' onclick='toggleTheme()'>Toggle Theme</button>
EOF

          echo "</body></html>" > temp_footer.html

      - name: Assemble Final HTML
        working-directory: theory/master
        run: |
          cat temp_header.html efc_master_raw.html temp_footer.html > efc_master.html

      - name: Move HTML to docs folder
        run: |
          mkdir -p docs
          cp theory/master/efc_master.html docs/efc_master.html

      # -------------------------------
      # Upload Artifacts
      # -------------------------------
      - name: Upload PDF
        uses: actions/upload-artifact@v4
        with:
          name: EFC_Master_PDF
          path: theory/master/efc_master.pdf

      - name: Upload HTML
        uses: actions/upload-artifact@v4
        with:
          name: EFC_Master_HTML
          path: docs/efc_master.html
