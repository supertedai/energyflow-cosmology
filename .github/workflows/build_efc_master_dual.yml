name: Build EFC Master (PDF + HTML)

on:
  push:
    paths:
      - "theory/master/**"
      - ".github/workflows/build_efc_master_dual.yml"
  workflow_dispatch:

jobs:
  build-master:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LaTeX + Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-latex-base \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-science \
            latexmk

      # -------------------------------
      # Build PDF
      # -------------------------------
      - name: Build EFC Master PDF
        working-directory: theory/master
        run: |
          latexmk -pdf -interaction=nonstopmode efc_master.tex

      # -------------------------------
      # Build HTML
      # -------------------------------
      - name: Convert LaTeX â†’ HTML (raw)
        working-directory: theory/master
        run: |
          pandoc efc_master.tex \
            --from=latex \
            --to=html5 \
            --mathjax \
            --standalone \
            --output=efc_master_raw.html

      - name: Create Header/Footer (safe YAML version)
        working-directory: theory/master
        run: |
          echo '<!DOCTYPE html>' > header.html
          echo '<html>' >> header.html
          echo '<head>' >> header.html
          echo '<meta charset="UTF-8">' >> header.html
          echo '<title>EFC Master Document</title>' >> header.html
          echo '<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>' >> header.html

          echo '<style>' >> header.html
          echo 'body { max-width: 900px; margin: auto; padding: 2rem; font-family: sans-serif; }' >> header.html
          echo 'img { max-width: 100%; height: auto; }' >> header.html
          echo 'pre, code { background: #f2f2f2; padding: 0.5rem; }' >> header.html
          echo 'html[data-theme="dark"] { background: #111; color: #ddd; }' >> header.html
          echo 'html[data-theme="light"] { background: #fff; color: #222; }' >> header.html
          echo '.theme-toggle { position: fixed; top: 10px; right: 10px; padding: 0.4rem 0.7rem; cursor: pointer; background: #444; color: #fff; border-radius: 5px; }' >> header.html
          echo '</style>' >> header.html

          echo '<script>' >> header.html
          echo 'function toggleTheme() {' >> header.html
          echo '  let h = document.documentElement;' >> header.html
          echo '  h.dataset.theme = (h.dataset.theme === "dark") ? "light" : "dark";' >> header.html
          echo '}' >> header.html
          echo '</script>' >> header.html

          echo '</head>' >> header.html
          echo '<body data-theme="light">' >> header.html
          echo '<button class="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>' >> header.html

          echo '</body></html>' > footer.html

      - name: Assemble Final HTML
        working-directory: theory/master
        run: |
          cat header.html efc_master_raw.html footer.html > efc_master.html

      - name: Move HTML to docs/
        run: |
          mkdir -p docs
          cp theory/master/efc_master.html docs/efc_master.html

      # -------------------------------
      # Upload Artifacts
      # -------------------------------
      - name: Upload PDF
        uses: actions/upload-artifact@v4
        with:
          name: EFC_Master_PDF
          path: theory/master/efc_master.pdf

      - name: Upload HTML
        uses: actions/upload-artifact@v4
        with:
          name: EFC_Master_HTML
          path: docs/efc_master.html
