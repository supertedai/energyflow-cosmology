name: Deploy Symbiose Query API

on:
  push:
    branches:
      - main
    paths:
      - "tools/symbiose_query_api.py"
      - "docker/Dockerfile.query_api"
      - ".github/workflows/deploy_query_api.yml"

env:
  GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
  REGION: europe-west1
  REPO_NAME: symbiose-api
  IMAGE_NAME: symbiose-query-api

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Authenticate via Workload Identity Federation
      - name: Google Auth (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # Install gcloud CLI (required before docker auth)
      - name: Install Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      # Allow docker to push to Artifact Registry
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker "${{ env.REGION }}-docker.pkg.dev"

      # Build Docker image
      - name: Build Docker image
        run: |
          docker build \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest \
            -f docker/Dockerfile.query_api .

      # Push Docker image
      - name: Push Docker image
        run: |
          docker push \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest

      # Deploy to Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.IMAGE_NAME }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest \
            --region=${{ env.REGION }} \
            --port=8082 \
            --allow-unauthenticated \
            --platform=managed \
            --set-env-vars=NEO4J_URI=${{ secrets.NEO4J_URI }},\
NEO4J_USER=${{ secrets.NEO4J_USER }},\
NEO4J_PASSWORD=${{ secrets.NEO4J_PASSWORD }},\
NEO4J_DATABASE=${{ secrets.NEO4J_DATABASE }},\
QDRANT_URL=${{ secrets.QDRANT_URL }},\
QDRANT_API_KEY=${{ secrets.QDRANT_API_KEY }},\
QDRANT_COLLECTION=efc_docs
