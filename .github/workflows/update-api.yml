name: Update EFC API
on:
  push:
    branches: [main]
    paths:
      - 'schema/concepts.json'

jobs:
  build-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare API folders
        run: |
          mkdir -p api/v1/concept
          cp schema/concepts.json api/v1/concepts.json
          jq -c '.hasDefinedTerm[]' schema/concepts.json | while read term; do
            id=$(echo $term | jq -r '.name' | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
            echo $term > api/v1/concept/${id}.json
          done

      - name: Generate simple term list
        run: |
          jq '[.hasDefinedTerm[] | {name: .name, id: .["@id"], url: ("https://energyflow-cosmology.com/concepts/" + (.name | gsub(" "; "-") | ascii_downcase))}]' schema/concepts.json > api/v1/terms.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add api/v1
          git commit -m "Auto-sync API endpoints"
          git push
