name: Update EFC API

on:
  push:
    branches: [main]
    paths:
      - 'schema/concepts.json'
      - 'methodology/**'
      - 'scripts/generate_methodology_api.py'
  workflow_dispatch:

jobs:
  build-api:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq and jsonlint
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq npm
          sudo npm install -g jsonlint

      - name: Prepare API folders
        run: |
          mkdir -p api/v1/concept
          rm -f api/v1/concept/*.json
          cp schema/concepts.json api/v1/concepts.json

          jq -c '.hasDefinedTerm[]' schema/concepts.json | while read -r term; do
            id=$(echo "$term" | jq -r '.name' \
              | iconv -f utf8 -t ascii//TRANSLIT \
              | sed 's/[^a-zA-Z0-9 -]//g' \
              | tr ' ' '-' \
              | tr '[:upper:]' '[:lower:]' \
              | tr -s '-' \
              | tr -cd '[:alnum:]-')
            echo "$term" > "api/v1/concept/${id}.json"
          done

      - name: Generate simplified term list
        run: |
          jq '[.hasDefinedTerm[] | {
            name: .name,
            id: .["@id"],
            url: ("https://energyflow-cosmology.com/concepts/" +
                  (.name | gsub(" "; "-")
                          | ascii_downcase
                          | gsub("[^a-z0-9-]"; "")))
          }]' schema/concepts.json > api/v1/terms.json

      - name: Generate methodology API
        run: python3 scripts/generate_methodology_api.py

      - name: Validate all generated JSON files
        run: |
          echo "üîé Validating JSON..."
          find api/v1 -name '*.json' -print0 | while IFS= read -r -d '' file; do
            jsonlint -q "$file" || { echo "‚ùå Invalid JSON in $file"; exit 1; }
          done
          echo "‚úÖ All JSON valid."

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add api/v1
          git commit -m "Auto-sync EFC API (concepts + terms + methodology)" || echo "No changes to commit"
          git push
