name: Figshare Sync (EFC v3 + robust metadata)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  figshare-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests python-slugify

      # === ORIGINAL FIGSHARE SYNC ===
      - name: Run Figshare Sync
        env:
          FIGSHARE_TOKEN: ${{ secrets.FIGSHARE_TOKEN }}
        run: python integrations/figshare/efc_figshare_sync_v3.py

      # === ROBUST METADATA.JSON SYNC (DOI â†’ SLUG FALLBACK) ===
      - name: Generate metadata.json for PDF folders (robust)
        env:
          FIGSHARE_TOKEN: ${{ secrets.FIGSHARE_TOKEN }}
        run: |
          python << 'EOF'
          import os
          import json
          import requests
          from pathlib import Path
          from slugify import slugify

          ROOT = Path(".").resolve()
          PAPERS = ROOT / "docs" / "papers" / "efc"
          FIGSHARE_DIR = ROOT / "figshare"
          DOI_MAP_FILE = FIGSHARE_DIR / "doi-map.json"

          TOKEN = os.getenv("FIGSHARE_TOKEN")
          if not TOKEN:
              raise SystemExit("FIGSHARE_TOKEN missing")

          if not DOI_MAP_FILE.exists():
              raise SystemExit("figshare/doi-map.json mangler")

          doi_map = json.loads(DOI_MAP_FILE.read_text(encoding="utf-8"))
          HEADERS = {"Authorization": f"token {TOKEN}"}

          r = requests.get("https://api.figshare.com/v2/account/articles", headers=HEADERS)
          r.raise_for_status()
          articles = r.json()

          figshare_by_doi = {}
          figshare_by_slug = {}

          for a in articles:
              title = a.get("title", "")
              doi = a.get("doi")
              article_id = a.get("id")

              d = requests.get(
                  f"https://api.figshare.com/v2/articles/{article_id}",
                  headers=HEADERS
              ).json()

              keywords = d.get("keywords", [])
              slug = slugify(title)

              entry = {
                  "title": title,
                  "slug": slug,
                  "doi": doi,
                  "keywords": keywords
              }

              if doi:
                  figshare_by_doi[doi] = entry

              figshare_by_slug[slug] = entry

          updated = 0
          skipped = 0

          for folder in PAPERS.iterdir():
              if not folder.is_dir():
                  continue

              pdfs = list(folder.glob("*.pdf"))
              if not pdfs:
                  continue

              meta_file = folder / "metadata.json"

              existing = {}
              if meta_file.exists():
                  try:
                      existing = json.loads(meta_file.read_text(encoding="utf-8"))
                  except:
                      pass

              existing_doi = existing.get("doi")
              local_slug = slugify(folder.name)

              data = None

              if existing_doi and existing_doi in figshare_by_doi:
                  data = figshare_by_doi[existing_doi]
              elif folder.name in doi_map and doi_map[folder.name] in figshare_by_doi:
                  data = figshare_by_doi[doi_map[folder.name]]
              elif local_slug in figshare_by_slug:
                  data = figshare_by_slug[local_slug]

              if not data:
                  print(f"[skip] No Figshare match for {folder.name}")
                  skipped += 1
                  continue

              meta = {
                  "title": data["title"],
                  "slug": data["slug"],
                  "doi": data["doi"],
                  "keywords": data["keywords"]
              }

              meta_file.write_text(
                  json.dumps(meta, indent=2, ensure_ascii=False),
                  encoding="utf-8"
              )

              print(f"[ok] Updated {meta_file}")
              updated += 1

          print(f"[done] Updated: {updated} | Skipped: {skipped}")
          EOF

      # === RIKTIG COMMIT (INGEN EXIT 1 LENGER) ===
      - name: Commit Figshare + metadata changes
        run: |
          git config user.name "figshare-bot"
          git config user.email "figshare-bot@users.noreply.github.com"

          if [[ -n "$(git status --porcelain)" ]]; then
            git add docs/papers/efc/**/metadata.json figshare/ figshare_sync_report.txt
            git commit -m "Auto-sync Figshare metadata + metadata.json"
            git push
          else
            echo "No metadata changes."
          fi

      # === RAPPORT (UENDRET) ===
      - name: Upload Sync Report
        uses: actions/upload-artifact@v4
        with:
          name: figshare-sync-report
          path: figshare_sync_report.txt
