name: Deploy Unified API to Cloud Run

on:
  push:
    branches: ["main"]
    paths:
      - "tools/symbiose_unified_api.py"
      - "semantic-search-index.json"
      - "docker/Dockerfile.unified_api"
      - ".github/workflows/deploy_unified_api.yml"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup gcloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_KEY }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: endless-precept-479020-n9

    - name: Configure Docker auth
      run: gcloud auth configure-docker europe-west1-docker.pkg.dev

    - name: Build Docker image
      run: |
        docker build \
          -t europe-west1-docker.pkg.dev/endless-precept-479020-n9/symbiose-api/symbiose-unified-api:latest \
          -f docker/Dockerfile.unified_api .

    - name: Push Docker image
      run: |
        docker push \
          europe-west1-docker.pkg.dev/endless-precept-479020-n9/symbiose-api/symbiose-unified-api:latest

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy unified-api \
          --region=europe-west1 \
          --image=europe-west1-docker.pkg.dev/endless-precept-479020-n9/symbiose-api/symbiose-unified-api:latest \
          --allow-unauthenticated
