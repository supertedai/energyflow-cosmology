name: Train Symbiose GNN

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "symbiose_gnn/**"
      - "neo4j/**"
      - "meta/**"
      - "meta-graph/**"
      - "schema/**"
      - "docs/**"

permissions:
  contents: write

jobs:
  train-gnn:
    runs-on: ubuntu-latest

    env:
      NEO4J_URI: ${{ secrets.NEO4J_URI }}
      NEO4J_USER: ${{ secrets.NEO4J_USER }}
      NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
      NEO4J_DATABASE: ${{ secrets.NEO4J_DATABASE }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required files
        run: |
          echo "[VALIDATE] Checking symbiose_gnn files..."
          for f in "__init__.py" "config.py" "data_loader.py" "model.py" "train.py" "embed.py"; do
            if [ ! -f "symbiose_gnn/$f" ]; then
              echo "Error: Missing file: symbiose_gnn/$f"
              exit 1
            fi
          done

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install "numpy<2"
          pip install torch==2.2.0 --index-url https://download.pytorch.org/whl/cpu
          pip install torch_geometric
          pip install neo4j-driver

      - name: Train GNN
        run: |
          export PYTHONPATH=$(pwd)
          python -m symbiose_gnn.train

      - name: Generate embeddings
        run: |
          export PYTHONPATH=$(pwd)
          python -m symbiose_gnn.embed

      - name: Commit embeddings
        run: |
          if [ -d "symbiose_gnn_output" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add symbiose_gnn_output/*
            if git diff --cached --quiet; then
              echo "No changes."
            else
              git commit -m "Auto: Update GNN embeddings"
              git push
            fi
          fi
