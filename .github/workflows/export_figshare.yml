      - name: Upload files to Figshare
        env:
          FIGSHARE_TOKEN: ${{ secrets.FIGSHARE_TOKEN }}
          FIGSHARE_ARTICLE_ID: ${{ secrets.FIGSHARE_ARTICLE_ID }}
        run: |
          python - << 'EOF'
import os
import requests
from pathlib import Path

token = os.getenv("FIGSHARE_TOKEN")
article_id = os.getenv("FIGSHARE_ARTICLE_ID")

ROOT = Path(os.getenv("GITHUB_WORKSPACE")).resolve()
OUTPUT_DIR = ROOT / "output"

print("Checking output directory:", OUTPUT_DIR)
if not OUTPUT_DIR.exists():
    print(f"No output directory found at: {OUTPUT_DIR}")
    raise SystemExit(0)   # EXIT SUCCESS

session = requests.Session()
session.headers.update({"Authorization": f"token {token}"})

ALLOWED = {".pdf", ".png", ".jpg", ".jpeg", ".csv"}

try:
    existing_files = session.get(
        f"https://api.figshare.com/v2/account/articles/{article_id}/files"
    ).json()
    existing_names = {f["name"] for f in existing_files}
except Exception as e:
    print("Could not fetch existing files:", e)
    existing_names = set()

print("Existing files:", existing_names)

def upload_file(file_path: Path):
    # Skip unsupported
    if file_path.suffix.lower() not in ALLOWED:
        print(f"[Figshare] Skipping unsupported file: {file_path.name}")
        return

    # Skip existing
    if file_path.name in existing_names:
        print(f"[Figshare] Already exists, skipping: {file_path.name}")
        return

    print(f"[Figshare] Uploading {file_path.name}")

    # 1. INIT
    init_res = session.post(
        f"https://api.figshare.com/v2/account/articles/{article_id}/files",
        json={"name": file_path.name}
    )
    if not init_res.ok:
        print(f"[Figshare] INIT FAILED {file_path.name}: {init_res.text}")
        return

    info = init_res.json()
    upload_url = info["upload_url"]
    file_id = info["id"]

    # 2. UPLOAD
    with file_path.open("rb") as f:
        put_res = requests.put(upload_url, data=f)

    if not put_res.ok:
        print(f"[Figshare] UPLOAD FAILED {file_path.name}: {put_res.text}")
        return

    # 3. COMPLETE
    complete_res = session.post(
        f"https://api.figshare.com/v2/account/articles/{article_id}/files/{file_id}"
    )
    if not complete_res.ok:
        print(f"[Figshare] COMPLETE FAILED {file_path.name}: {complete_res.text}")
        return

    print(f"[Figshare] Uploaded OK: {file_path.name}")


for path in OUTPUT_DIR.rglob("*"):
    if path.is_file():
        upload_file(path)

print("[Figshare] Workflow finished with NO errors.")
EOF
