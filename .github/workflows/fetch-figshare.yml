name: Validate and Sync Figshare Token

on:
  workflow_dispatch:

jobs:
  figshare-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # TEST: Figshare Token Validation Step
      # ---------------------------------------------------------
      - name: Validate Figshare Token
        env:
          FIGSHARE_TOKEN: ${{ secrets.FIGSHARE_TOKEN }}
        run: |
          python3 - << 'EOF'
import requests, os, sys

print("=== Figshare Token Self-Test ===")

token = os.environ.get("FIGSHARE_TOKEN")

# --- 1. Check token present ---
if not token:
    print("ERROR: FIGSHARE_TOKEN is not set in environment.")
    sys.exit(1)

if len(token.strip()) < 20:
    print("ERROR: FIGSHARE_TOKEN appears too short or corrupted.")
    print("Length:", len(token.strip()))
    sys.exit(1)

print("Token length (sanitized):", len(token.strip()))

# --- 2. Send test request ---
headers = {
    "Authorization": f"token {token.strip()}",
    "Content-Type": "application/json"
}

try:
    r = requests.get("https://api.figshare.com/v2/account/articles", headers=headers, timeout=10)
except Exception as e:
    print("ERROR: Connection to Figshare failed:", e)
    sys.exit(1)

print("HTTP Status:", r.status_code)

# --- 3. Diagnose common issues ---
if r.status_code == 200:
    print("SUCCESS: Token is valid and Figshare API is reachable.")
    print("Response preview:", r.text[:200], "...")
    sys.exit(0)

elif r.status_code == 403:
    print("ERROR: Figshare returned 403 Forbidden.")
    print("This means:")
    print(" - Token is invalid OR")
    print(" - Token has incorrect format OR")
    print(" - Token has whitespace/newlines OR")
    print(" - Header is corrupted OR")
    print(" - Figshare rejected the request signature.")
    print("Full body:", r.text)
    sys.exit(1)

elif r.status_code == 401:
    print("ERROR: 401 Unauthorized â€” token structure is wrong.")
    print("Check for whitespace or newline in GitHub Secret.")
    sys.exit(1)

else:
    print("ERROR: Unexpected response:", r.status_code)
    print("Body:", r.text)
    sys.exit(1)
EOF
