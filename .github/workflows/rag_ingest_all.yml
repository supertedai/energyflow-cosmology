name: RAG Ingest (Qdrant Only)

on:
  workflow_dispatch:   # Kun manuell kjÃ¸ring (tryggest)
  # Hvis du senere vil ha fast intervall, kan du aktivere denne:
  # schedule:
  #   - cron: "30 2 * * *"  # 04:30 Oslo

jobs:
  rag-ingest:
    runs-on: ubuntu-latest

    env:
      QDRANT_URL: ${{ secrets.QDRANT_URL }}
      QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
      QDRANT_COLLECTION: "efc"
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      # ---------------------------
      # 0. CHECKOUT
      # ---------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------
      # 1. PYTHON SETUP
      # ---------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ---------------------------
      # 2. RUN RAG INGEST (QDRANT ONLY)
      # ---------------------------
      - name: Run RAG ingest to Qdrant
        run: |
          echo ">>> Starting controlled RAG ingest to Qdrant (collection: efc)"
          python tools/rag_ingest_all.py

      # ---------------------------
      # 3. VERIFY QDRANT
      # ---------------------------
      - name: Verify Qdrant collection
        run: |
          echo ">>> Verifying Qdrant collection exists"
          python - << 'EOF'
          from qdrant_client import QdrantClient
          import os

          client = QdrantClient(
              url=os.environ["QDRANT_URL"],
              api_key=os.environ["QDRANT_API_KEY"],
          )

          col = os.environ.get("QDRANT_COLLECTION", "efc")
          cols = [c.name for c in client.get_collections().collections]

          if col in cols:
              print(f"[OK] Collection '{col}' exists.")
          else:
              raise SystemExit(f"[ERROR] Collection '{col}' not found!")
          EOF

      # ---------------------------
      # 4. DONE
      # ---------------------------
      - name: Done
        run: |
          echo ">>> RAG ingest completed safely."
