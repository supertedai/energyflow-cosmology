name: Sync RAG to Neo4j

on:
  workflow_dispatch: {}
  workflow_run:
    workflows: ["Full RAG Ingest"]
    types: [completed]

jobs:
  sync-rag-neo4j:
    runs-on: ubuntu-latest

    env:
      QDRANT_URL: ${{ secrets.QDRANT_URL }}
      QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
      QDRANT_COLLECTION: "efc_docs"
      NEO4J_URI: ${{ secrets.NEO4J_URI }}
      NEO4J_USER: ${{ secrets.NEO4J_USER }}
      NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install qdrant-client neo4j

      - name: Debug secrets
        run: |
          echo "URL: $QDRANT_URL"
          echo "API KEY LENGTH: ${#QDRANT_API_KEY}"
          printf 'KEY HEX: '
          printf '%s' "$QDRANT_API_KEY" | hexdump -C

      - name: Run sync from RAG to Neo4j
        run: |
          python tools/sync_rag_to_neo4j.py
