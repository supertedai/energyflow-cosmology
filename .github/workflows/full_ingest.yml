import os
import uuid
from pathlib import Path
from typing import List

from qdrant_client import QdrantClient
from qdrant_client.models import VectorParams, Distance, PointStruct
from openai import OpenAI
import pypdf


# -----------------------------------------
# CONFIG â€“ CLOUD ONLY
# -----------------------------------------
ROOT = Path(__file__).resolve().parents[1]

QDRANT_URL = os.getenv("QDRANT_URL")
QDRANT_API_KEY = os.getenv("QDRANT_API_KEY")
QDRANT_COLLECTION = os.getenv("QDRANT_COLLECTION", "efc")   # <â€“ riktig

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
EMBED_MODEL = os.getenv("EMBEDDING_MODEL", "text-embedding-3-large")
EMBED_DIM = int(os.getenv("EMBEDDING_DIM", "1536"))

# Kun PDF + Markdown
ALLOWED_EXT = {".pdf", ".md"}


# -----------------------------------------
# FILE SCANNING (kun docs/papers/efc og docs/)
# -----------------------------------------
def list_ingest_files() -> List[Path]:
    folders = [
        ROOT / "docs" / "papers" / "efc",
        ROOT / "docs"
    ]

    files = []
    for folder in folders:
        if not folder.exists():
            continue
        for p in folder.rglob("*"):
            if p.is_file() and p.suffix.lower() in ALLOWED_EXT:
                files.append(p)

    return files


# -----------------------------------------
# PDF TEXT EXTRACTOR
# -----------------------------------------
def read_pdf(path: Path) -> str:
    text = ""
    with open(path, "rb") as f:
        reader = pypdf.PdfReader(f)
        for page in reader.pages:
            text += page.extract_text() + "\n"
    return text


# -----------------------------------------
# CHUNKING
# -----------------------------------------
def chunk_text(text: str, max_chars=1300) -> List[str]:
    chunks = []
    while len(text) > max_chars:
        split = text.rfind("\n", 0, max_chars)
        if split == -1:
            split = max_chars
        chunks.append(text[:split].strip())
        text = text[split:].strip()
    if text:
        chunks.append(text)
    return chunks


# -----------------------------------------
# EMBEDDINGS
# -----------------------------------------
def embed_texts(client, texts: List[str]):
    resp = client.embeddings.create(
        model=EMBED_MODEL,
        input=texts,
    )
    return [x.embedding for x in resp.data]


# -----------------------------------------
# MAIN
# -----------------------------------------
def main():
    print("")
    print("=============================================")
    print(" ðŸ”¥ LOCAL CLOUD INGEST (SAFE MODE) START")
    print("=============================================")
    print(f"Using Qdrant collection: {QDRANT_COLLECTION}")
    print("")

    qdrant = QdrantClient(
        url=QDRANT_URL,
        api_key=QDRANT_API_KEY
    )

    # ---------------------------------------------------
    # Do NOT delete Cloud data. We only upsert.
    # ---------------------------------------------------
    if not qdrant.collection_exists(QDRANT_COLLECTION):
        print(f"[INIT] Creating collection {QDRANT_COLLECTION}")
        qdrant.create_collection(
            collection_name=QDRANT_COLLECTION,
            vectors_config=VectorParams(
                size=EMBED_DIM,
                distance=Distance.COSINE
            )
        )
    else:
        print(f"[INIT] Using existing collection: {QDRANT_COLLECTION}")

    openai_client = OpenAI(api_key=OPENAI_API_KEY)

    files = list_ingest_files()
    print(f"[FILES] {len(files)} ingestable files")

    total_chunks = 0

    for f in files:
        relative = f.relative_to(ROOT)
        print(f"[PROCESS] {relative}")

        # Read file content
        if f.suffix.lower() == ".pdf":
            text = read_pdf(f)
        else:
            text = f.read_text(encoding="utf-8", errors="ignore")

        if not text.strip():
            print(f"  -> skipped (empty)")
            continue

        chunks = chunk_text(text)
        print(f"  -> {len(chunks)} chunks")

        vectors = embed_texts(openai_client, chunks)

        points = []
        for i, chunk in enumerate(chunks):
            points.append(
                PointStruct(
                    id=str(uuid.uuid4()),
                    vector=vectors[i],
                    payload={
                        "source": str(relative),
                        "text": chunk,
                        "chunk_index": i
                    }
                )
            )

        qdrant.upsert(
            collection_name=QDRANT_COLLECTION,
            points=points
        )

        total_chunks += len(chunks)

    print("")
    print(f"âœ¨ DONE â€“ uploaded {total_chunks} chunks to {QDRANT_COLLECTION}")
    print("")


if __name__ == "__main__":
    main()
