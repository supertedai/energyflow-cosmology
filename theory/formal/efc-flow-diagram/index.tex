% ======================================================================
% EFC Flow Diagram â€” Formal Specification
% ======================================================================

\documentclass[tikz,border=10pt]{standalone}

\usetikzlibrary{arrows.meta, positioning, shapes.geometric}

\begin{document}

% ----------------------------------------------------------------------
% Style
% ----------------------------------------------------------------------
\tikzset{
    box/.style={
        rectangle,
        rounded corners,
        draw=black,
        thick,
        align=center,
        minimum width=4cm,
        minimum height=1.2cm
    },
    arrow/.style={
        -{Latex[length=3mm]},
        thick
    }
}

% ----------------------------------------------------------------------
% Diagram
% ----------------------------------------------------------------------
\begin{tikzpicture}[node distance=1.6cm]

% --- Nodes -------------------------------------------------------------

\node[box] (grid) {Grid State \\ $G$};
\node[box, below=of grid] (entropy) {Entropy Field \\ $S(G)$};
\node[box, below=of entropy] (efield) {Energy--Flow Field \\ $E_f = \rho(1 - S)$};
\node[box, below=of efield] (structure) {Structure Formation \\ $\rho(r),\, v(r)$ profiles};

\node[box, right=3.5cm of entropy] (feedback_s) {Feedback to $S$};
\node[box, right=3.5cm of efield] (feedback_g) {Feedback to Grid};

% --- Arrows ------------------------------------------------------------

\draw[arrow] (grid) -- (entropy);
\draw[arrow] (entropy) -- (efield);
\draw[arrow] (efield) -- (structure);

% Feedback loops
\draw[arrow] (structure.east) -| (feedback_s.south);
\draw[arrow] (feedback_s.north) |- (entropy.east);

\draw[arrow] (structure.east) -| (feedback_g.south);
\draw[arrow] (feedback_g.north) |- (grid.east);

\end{tikzpicture}

\end{document}
